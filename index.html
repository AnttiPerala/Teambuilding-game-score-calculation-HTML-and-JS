
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Team-Building Card Game — Minimal Round Entry</title>
<style>
  :root{
    --bg:#0b0f14;
    --panel:#0f1620;
    --panel-2:#0d1219;
    --text:#e6f0ff;
    --muted:#9fb3cc;
    --accent:#60a5fa;
    --accent-2:#22d3ee;
    --accent-3:#a78bfa;
    --good:#22c55e;
    --warn:#fbbf24;
    --bad:#ef4444;
    --border:#1f2937;
    --r:14px;
    --bezier:cubic-bezier(.2,.7,.2,1);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.15), transparent 70%),
      radial-gradient(900px 500px at 90% 10%, rgba(167,139,250,.12), transparent 70%),
      radial-gradient(600px 400px at 40% 120%, rgba(34,211,238,.10), transparent 70%),
      #0b0f14;
  }
  .app{display:flex;flex-direction:column;min-height:100%}
  header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(120%) blur(6px);background:linear-gradient(to bottom, rgba(13,18,25,.9), rgba(13,18,25,.6));border-bottom:1px solid var(--border)}
  .hwrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  .subtitle{color:var(--muted);font-size:.95rem}
  .spacer{flex:1}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:linear-gradient(180deg,#0e1622,#0b111a);border:1px solid var(--border);padding:8px 10px;border-radius:999px;display:flex;gap:8px;align-items:center;font-weight:550}
  .score{min-width:110px;justify-content:center}
  .progress{width:240px}
  .progress .bar{position:relative;height:10px;background:#0a1018;border-radius:999px;border:1px solid var(--border);overflow:hidden}
  .progress .bar>span{position:absolute;inset:0 100% 0 0;background:linear-gradient(90deg, rgba(96,165,250,.45), rgba(34,211,238,.6));transition:inset .8s var(--bezier)}
  main{flex:1;display:flex}
  .container{max-width:1100px;margin:18px auto 110px;flex:1;padding:0 16px}
  .panel{background:linear-gradient(180deg, #0f1620, #0d1219);border:1px solid var(--border);border-radius:var(--r);padding:16px}
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  label{display:block;font-weight:600;margin-bottom:6px}
  input[type="text"], input[type="number"], select{width:100%;padding:10px 12px;border-radius:10px;background:#0b1119;color:var(--text);border:1px solid #1a2433}
  input:focus, select:focus{outline:none;border-color:#264966;box-shadow:0 0 0 2px rgba(96,165,250,.25)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--border);background:#0c141e;color:var(--text);border-radius:11px;padding:10px 14px;font-weight:650;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#12304a,#0e2436);border-color:#1f3a56}
  .btn.danger{border-color:#3a1a1a;background:linear-gradient(180deg,#2a0f12,#1a0b0c)}
  .hint{font-size:.95rem;color:var(--muted)}
  .sumline{font-weight:650}
  .sum-ok{color:#22c55e} .sum-under{color:#fbbf24} .sum-over{color:#ef4444}
  .hidden{display:none !important}
  .play-card{max-width:720px;margin:12px auto;gap:16px}
  .huge{font-size:1.6rem}
  .tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0b1118}
  .drawer{position:fixed;left:0;right:0;bottom:0;z-index:6;padding:0 16px 16px}
  .drawer .inner{max-width:1100px;margin:0 auto;background:linear-gradient(180deg,#0f151e,#0b1017);border:1px solid var(--border);border-radius:16px}
  .drawer .bar{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--border)}
  .drawer .content{padding:12px;display:none}
  .drawer.open .content{display:block}
  .drawer .caret{transform:rotate(0);transition:transform .25s var(--bezier)}
  .drawer.open .caret{transform:rotate(180deg)}
  .overlay{position:fixed;inset:0;display:none;place-items:center;z-index:20;background:rgba(2,6,12,.55)}
  .overlay.show{display:grid}
  .modal{width:min(680px, calc(100vw - 32px));background:linear-gradient(180deg,#0f1724,#0b111a);border:1px solid var(--border);border-radius:16px;padding:16px}
  .pb{height:12px;background:#0a1018;border-radius:999px;border:1px solid var(--border);overflow:hidden}
  .pb>span{display:block;height:100%;width:0%;background:linear-gradient(90deg, rgba(34,211,238,.7), rgba(167,139,250,.7));transition:width .9s cubic-bezier(.2,.7,.2,1)}
  .team-card{padding:12px;border:1px solid var(--border);border-radius:14px;background:#0b1119}
  .team-title{font-weight:700;margin-bottom:6px}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="hwrap">
      <div>
        <div class="title">Team-Building Card Game</div>
        <div class="subtitle">Enter one card at a time. First card sets baseline; scoring starts at the 2nd. Points start at 0; more is better.</div>
      </div>
      <div class="spacer"></div>
      <div class="chips">
        <div class="chip score" id="score1">Group 1: 0</div>
        <div class="chip score" id="score2">Group 2: 0</div>
        <div class="chip progress">
          <div class="row" style="gap:8px;align-items:center">
            <small id="progressLabel">0 / ?</small>
          </div>
          <div class="bar" aria-hidden="true"><span id="progressBar"></span></div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">

      <section id="setupSec" class="panel">
        <h2 style="margin:6px 0 10px">Setup</h2>
        <div class="grid cols-2">
          <div>
            <label>Skills (4)</label>
            <div class="grid cols-2">
              <input type="text" id="skill0" placeholder="Visual" />
              <input type="text" id="skill1" placeholder="Sound" />
              <input type="text" id="skill2" placeholder="Programming" />
              <input type="text" id="skill3" placeholder="Project Management" />
            </div>
          </div>
          <div>
            <label>Participants (optional)</label>
            <input type="number" id="participants" min="0" step="1" placeholder="e.g., 20" />
            <div class="hint">Used for progress + fairness guard</div>
          </div>
        </div>

        <details style="margin-top:12px">
          <summary class="hint">Optional settings</summary>
          <div class="grid cols-2" style="margin-top:10px">
            <div>
              <label>Group 1 name</label>
              <input type="text" id="gname0" placeholder="Group 1" />
            </div>
            <div>
              <label>Group 2 name</label>
              <input type="text" id="gname1" placeholder="Group 2" />
            </div>
            <div>
              <label>Remainder placement mode</label>
              <div class="row">
                <label class="tag"><input type="radio" name="remainderMode" value="distribute" checked />&nbsp;Distribute to 5th members</label>
                <label class="tag"><input type="radio" name="remainderMode" value="ownTeam" />&nbsp;Own smaller team</label>
              </div>
            </div>
          </div>
        </details>

        <div class="row" style="margin-top:14px;justify-content:flex-end">
          <button class="btn primary" id="startBtn">Start</button>
        </div>
        <div class="hint">Setup is saved in your browser (localStorage).</div>
      </section>

      <section id="playSec" class="panel hidden">
        <div class="play-card grid">
          <div class="row" style="justify-content:space-between">
            <div>Now creating <strong id="turnInfoTeam">Team 1</strong></div>
            <div class="hint" id="turnInfoCard">Card 1 / 4</div>
          </div>
          <div class="huge" id="pickerPrompt">Group X — pick a card</div>
          <div class="hint" id="noScoreNote">(no points this card)</div>

          <div class="grid cols-2" id="entryGrid">
            <div>
              <label for="studentName">Card name (student)</label>
              <input type="text" id="studentName" placeholder="Name" />
            </div>
            <div class="grid cols-2" id="skillInputs"></div>
          </div>

          <div class="sumline" id="sumLine">Sum: 0 / 20</div>

          <div class="row" style="justify-content:space-between">
            <div class="row">
              <button class="btn" id="prevTeam">Prev team</button>
              <button class="btn" id="nextTeam">Next team</button>
              <button class="btn" id="backCard">Back</button>
            </div>
            <div class="row">
              <button class="btn danger" id="resetBtn">Reset data</button>
              <button class="btn primary" id="lockBtn" disabled>Lock card</button>
            </div>
          </div>

        </div>
      </section>

      <section id="endSec" class="panel hidden">
        <h2 style="margin:6px 0 6px">Scoring finished</h2>
        <div class="hint" id="endReason"></div>
        <div class="row" style="margin-top:10px;gap:14px;flex-wrap:wrap">
          <div class="chip" id="finalScore1">Group 1: 0</div>
          <div class="chip" id="finalScore2">Group 2: 0</div>
          <div class="chip" id="winnerChip">Winner: —</div>
        </div>
        <div class="row" style="margin-top:12px;justify-content:flex-end;gap:10px">
          <button class="btn" id="toIntake">Add remaining cards</button>
          <button class="btn primary" id="toFinal">Skip &amp; view teams</button>
        </div>
      </section>

      <section id="intakeSec" class="panel hidden">
        <h2 style="margin:6px 0 10px">Add remaining cards</h2>
        <div class="hint" id="intakeHint">Enter cards below. Only rows that sum to 20 are included.</div>
        <div id="intakeRows" class="grid" style="margin-top:10px;gap:10px"></div>
        <div class="row" style="margin-top:12px;justify-content:space-between">
          <button class="btn" id="addRow">Add another card</button>
          <button class="btn primary" id="assignAuto">Assign &amp; continue</button>
        </div>
      </section>

      <section id="finalSec" class="panel hidden">
        <h2 style="margin:6px 0 10px">Final Teams</h2>
        <div class="final-list" id="finalList"></div>
        <div class="row" style="margin-top:12px;justify-content:flex-end;gap:10px">
          <button class="btn" id="exportCSV">Export CSV</button>
          <button class="btn" id="exportJSON">Export JSON</button>
          <button class="btn danger" id="restart">Restart program</button>
        </div>
      </section>

    </div>
  </main>

  <div class="drawer" id="drawer">
    <div class="inner">
      <div class="bar">
        <button class="btn" id="toggleDrawer" aria-expanded="false"><span class="caret">▴</span>&nbsp;Settings</button>
        <div class="hint">Runtime editing for names, participants, skills, remainder, and per-team stage owners</div>
      </div>
      <div class="content">
        <div class="grid cols-2">
          <div class="panel">
            <div class="grid cols-2">
              <div><label>Group 1 name</label><input type="text" id="dgname0" /></div>
              <div><label>Group 2 name</label><input type="text" id="dgname1" /></div>
              <div><label>Participants</label><input type="number" id="dparticipants" min="0" step="1" /></div>
              <div>
                <label>Remainder mode</label>
                <select id="dremainder">
                  <option value="distribute">Distribute (5th members)</option>
                  <option value="ownTeam">Own smaller team</option>
                </select>
              </div>
            </div>
            <div style="margin-top:10px">
              <label>Skills</label>
              <div class="grid cols-4">
                <input type="text" id="dskill0" />
                <input type="text" id="dskill1" />
                <input type="text" id="dskill2" />
                <input type="text" id="dskill3" />
              </div>
            </div>
            <div class="row" style="margin-top:10px;justify-content:flex-end">
              <button class="btn primary" id="drawerSave">Save settings</button>
            </div>
          </div>

          <div class="panel">
            <label>Per-team stage ownership (optional)</label>
            <div id="ownerEditor" class="grid" style="gap:8px"></div>
            <div class="hint">Pair/Triplet/Quartet points go to the selected group per team.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <div id="overlayTitle" class="big">Stage result</div>
      <div class="hint" id="overlayOwner">Points → Group</div>
      <div class="pb" style="margin:10px 0 6px"><span id="overlayPB"></span></div>
      <div class="row" id="overlayStats"></div>
      <ul class="stage-list" id="overlayList" style="margin:8px 0 0;padding-left:18px"></ul>
      <div class="row" style="margin-top:12px;justify-content:flex-end;gap:10px">
        <button class="btn" id="overlayUndo">Undo last lock</button>
        <button class="btn primary" id="overlayClose">Continue</button>
      </div>
    </div>
  </div>

</div>

<script>
(function(){
  "use strict";
  const LSKEY = "tbcg_state_v1";

  function defaultTeam(i){
    const pairToGroup = (i % 2 === 0) ? 1 : 0;
    const tripToGroup = 1 - pairToGroup;
    const quadToGroup = pairToGroup;
    return {cards:[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],names:["","","",""],locked:[false,false,false,false],extras:[],pairToGroup,tripToGroup,quadToGroup};
  }
  function defaultState(){
    return {
      setupDone:false,
      skills:["Visual","Sound","Programming","Project Management"],
      participants:0,
      groupNames:["Group 1","Group 2"],
      remainderMode:"distribute",
      currentTeam:0,
      currentCard:0,
      scoringEnded:false,
      endWhy:"",
      totals:[0,0],
      teams:[defaultTeam(0),defaultTeam(1),defaultTeam(2),defaultTeam(3)],
      lastLock:null
    };
  }
  let S = load();
  function load(){
    try{ const raw = localStorage.getItem(LSKEY); if(raw){ return JSON.parse(raw); } }catch(e){}
    return defaultState();
  }
  function save(){ localStorage.setItem(LSKEY, JSON.stringify(S)); }
  function resetAll(){ localStorage.removeItem(LSKEY); S=defaultState(); render(); }

  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
  function sum(a){ return a.reduce((x,y)=>x+y,0); }

  function cardEntered(ti,ci){
    const t=S.teams[ti]; const vals=t.cards[ci]||[0,0,0,0]; const name=(t.names[ci]||"").trim();
    if(t.locked[ci]) return true; if(name) return true; return vals.some(v=>v>0);
  }
  function totalEnteredCards(){ let c=0; for(let ti=0;ti<S.teams.length;ti++){ for(let ci=0;ci<4;ci++){ if(cardEntered(ti,ci)) c++; } } return c; }
  function presentCountForTeam(ti){ let k=0; for(let ci=0;ci<4;ci++){ if(cardEntered(ti,ci)) k++; } return k; }

  // STRICT FAIRNESS: require enough remaining cards so all teams can reach the same next scoring stage
  function fairnessCheckMaybe(){
    if(!S.participants || S.participants<=0) return;
    const entered = totalEnteredCards();
    const remaining = Math.max(0, S.participants - entered);

    // Count present cards for a team (entered = locked OR any value OR a name)
    function presentCountTeam(ti){
      let k=0; for(let ci=0;ci<4;ci++){ if(cardEntered(ti,ci)) k++; } return k;
    }
    const ti = S.currentTeam;
    const k = presentCountTeam(ti);

    // Never stop in the middle of a team: allow finishing to 4
    if(k>0 && k<4) return;

    // Only evaluate before starting a fresh team (k == 0)
    if(k===0){
      // Completed full teams so far
      let completed = 0;
      for(let j=0;j<4;j++){ if(presentCountTeam(j) >= 4) completed++; }

      // Remaining teams we could still complete (including this one)
      const teamsRemaining = 4 - completed;
      const maxCompletableTeams = Math.min(teamsRemaining, Math.floor(remaining / 4));

      const totalIfProceed = completed + maxCompletableTeams;

      // To keep groups' scoring rounds equal (pair+quad vs trip mapping), require an EVEN number of full teams.
      if(totalIfProceed % 2 === 1){
        S.scoringEnded = true;
        S.endWhy = `Fairness: only ${remaining} cards left. Completing more teams would result in an odd number of full teams (${totalIfProceed}), giving one group an extra scoring round. Stopping now keeps scoring rounds equal.`;
        save(); showSection("end"); return;
      }
    }
  }
function ownerForStage(team, stage){
    if(stage==="pair") return team.pairToGroup;
    if(stage==="triplet") return team.tripToGroup;
    if(stage==="quartet") return team.quadToGroup;
    return 0;
  }
  function stageTargetForCardIndex(idx){
    if(idx===1) return {stage:"pair", target:10, max:40};
    if(idx===2) return {stage:"triplet", target:15, max:60};
    if(idx===3) return {stage:"quartet", target:20, max:80};
    return {stage:"baseline", target:0, max:0};
    }
  function teamSumUpTo(team, upTo){ const sums=[0,0,0,0]; for(let i=0;i<=upTo;i++){ const v=team.cards[i]||[0,0,0,0]; for(let k=0;k<4;k++) sums[k]+=v[k]; } return sums; }
  function stagePointsFromSums(sums, target){ let pts=0; const perSkill=[]; for(let i=0;i<4;i++){ const d=Math.abs(target - sums[i]); const p=target - d; perSkill.push({delta:sums[i]-target, points:p}); pts+=p; } return {pts, perSkill}; }
  function pickerIndexFor(ti, ci){ const team=S.teams[ti]; const starterIndex = 1 - team.pairToGroup; return (ci % 2 === 0) ? starterIndex : (1 - starterIndex); }
  function allTeamsComplete(){ return S.teams.slice(0,4).every(t => t.locked.filter(Boolean).length===4); }

  function renderHeader(){
    $("#score1").textContent = `${S.groupNames[0]}: ${S.totals[0]}`;
    $("#score2").textContent = `${S.groupNames[1]}: ${S.totals[1]}`;
    const entered = totalEnteredCards();
    if(S.participants && S.participants>0){
      const pct = clamp(entered / S.participants, 0, 1);
      $("#progressLabel").textContent = `${entered} / ${S.participants} (${Math.round(pct*100)}%)`;
      $("#progressBar").style.insetInlineEnd = `${(1 - pct)*100}%`;
    }else{
      $("#progressLabel").textContent = `${entered} cards entered`;
      const pct = clamp((entered%20)/20, 0, 1);
      $("#progressBar").style.insetInlineEnd = `${(1 - pct)*100}%`;
    }
  }
  function skillNames(){ return S.skills && S.skills.length===4 ? S.skills : ["Skill 1","Skill 2","Skill 3","Skill 4"]; }

  function rebuildSkillInputs(ti, ci){
    const grid=$("#skillInputs"); grid.innerHTML="";
    const t=S.teams[ti]; const vals=t.cards[ci]||[0,0,0,0];
    for(let i=0;i<4;i++){
      const wrap=document.createElement("div"); const lab=document.createElement("label"); lab.textContent=skillNames()[i]; lab.setAttribute("for", `skill_${i}`);
      const inp=document.createElement("input"); inp.type="number"; inp.min="0"; inp.max="20"; inp.step="1"; inp.id=`skill_${i}`; inp.value=vals[i];
      inp.addEventListener("input", ()=>{ const v=parseInt(inp.value||"0",10); t.cards[ci][i]=isNaN(v)?0:clamp(v,0,20); updateSumLine(ti,ci); save(); });
      if(t.locked[ci]) inp.disabled=true;
      wrap.appendChild(lab); wrap.appendChild(inp); grid.appendChild(wrap);
    }
  }
  function updateSumLine(ti,ci){
    const t=S.teams[ti]; const s=sum(t.cards[ci]);
    const line=$("#sumLine"); let txt="", cls="";
    if(s===20){ cls="sum-ok"; txt="Looks good – ready to lock"; }
    else if(s<20){ cls="sum-under"; txt=`Under by ${20-s}`; }
    else { cls="sum-over"; txt=`Over by ${s-20}`; }
    line.className=`sumline ${cls}`; line.textContent=`Sum: ${s} / 20 — ${txt}`;
    $("#lockBtn").disabled = !(s===20 && !t.locked[ci]);
  }
  function renderPlay(){
    const ti=S.currentTeam, ci=S.currentCard, t=S.teams[ti];
    $("#turnInfoTeam").textContent=`Team ${ti+1}`;
    $("#turnInfoCard").textContent=`Card ${ci+1} / 4`;
    const pickerIdx = pickerIndexFor(ti, ci);
    $("#pickerPrompt").innerHTML = `<span style="color:#22d3ee">${S.groupNames[pickerIdx]}</span> — pick a card`;
    $("#noScoreNote").classList.toggle("hidden", !(ci===0));
    const nameEl=$("#studentName"); nameEl.value=t.names[ci]||""; nameEl.disabled=!!t.locked[ci];
    nameEl.oninput=(e)=>{ t.names[ci]=(e.target.value||"").slice(0,120); updateSumLine(ti,ci); save(); };
    rebuildSkillInputs(ti,ci); updateSumLine(ti,ci);
    $("#backCard").disabled=(ci===0);
  }
  function renderEnd(){
    $("#endReason").textContent=S.endWhy || "All teams completed.";
    $("#finalScore1").textContent=`${S.groupNames[0]}: ${S.totals[0]}`;
    $("#finalScore2").textContent=`${S.groupNames[1]}: ${S.totals[1]}`;
    const w = S.totals[0]===S.totals[1] ? "Tie" : (S.totals[0]>S.totals[1]?S.groupNames[0]:S.groupNames[1]);
    $("#winnerChip").textContent=`Winner: ${w}`;
  }
  function renderOwnerEditor(){
    const root=$("#ownerEditor"); root.innerHTML="";
    S.teams.forEach((t,i)=>{
      const row=document.createElement("div"); row.className="row"; row.innerHTML=`<div class="tag"><strong>Team ${i+1}</strong></div>`;
      const mk=(label,key)=>{ const wrap=document.createElement("label"); wrap.className="tag"; const sel=document.createElement("select");
        sel.innerHTML=`<option value="0">${S.groupNames[0]}</option><option value="1">${S.groupNames[1]}</option>`; sel.value=String(t[key]);
        sel.onchange=()=>{ t[key]=parseInt(sel.value,10); save(); render(); }; wrap.append(`${label}: `); wrap.appendChild(sel); return wrap; };
      row.appendChild(mk("Pair→","pairToGroup")); row.appendChild(mk("Triplet→","tripToGroup")); row.appendChild(mk("Quartet→","quadToGroup"));
      root.appendChild(row);
    });
  }
  function renderFinal(){
    const wrap=$("#finalList"); wrap.innerHTML="";
    S.teams.forEach((t,i)=>{
      if(i>3 && (!t.cards || t.cards.length===0)) return;
      const card=document.createElement("div"); card.className="team-card";
      const title=document.createElement("div"); title.className="team-title"; title.textContent=`Team ${i+1}`; card.appendChild(title);
      const ul=document.createElement("ul"); ul.style.margin="0"; ul.style.paddingLeft="18px";
      for(let k=0;k<4;k++){ const name=t.names[k]||"(empty)"; const vals=t.cards[k]||[0,0,0,0]; const li=document.createElement("li"); li.textContent=`${name} · ${vals.join("-")}`; ul.appendChild(li); }
      if(t.extras && t.extras.length){ const li=document.createElement("li"); li.innerHTML="<em>Extras:</em>"; ul.appendChild(li);
        t.extras.forEach(ex=>{ const li2=document.createElement("li"); li2.textContent=`${ex.name} · ${ex.values.join("-")} (extra)`; ul.appendChild(li2); });
      }
      card.appendChild(ul); wrap.appendChild(card);
    });
  }
  function showSection(which){
    $("#setupSec").classList.toggle("hidden", which!=="setup");
    $("#playSec").classList.toggle("hidden", which!=="play");
    $("#endSec").classList.toggle("hidden", which!=="end");
    $("#intakeSec").classList.toggle("hidden", which!=="intake");
    $("#finalSec").classList.toggle("hidden", which!=="final");
    renderHeader();
    if(which==="play"){ renderPlay(); fairnessCheckMaybe(); }
    if(which==="end"){ renderEnd(); }
    if(which==="intake"){ buildIntakeRows(); }
    if(which==="final"){ renderFinal(); }
  }
  function render(){
    if(!S.setupDone){
      $("#skill0").value=S.skills[0]; $("#skill1").value=S.skills[1]; $("#skill2").value=S.skills[2]; $("#skill3").value=S.skills[3];
      $("#participants").value=S.participants||""; $("#gname0").value=S.groupNames[0]; $("#gname1").value=S.groupNames[1];
      $$("input[name='remainderMode']").forEach(r=>r.checked=(r.value===S.remainderMode));
      showSection("setup");
    }else if(S.scoringEnded || allTeamsComplete()){
      if(allTeamsComplete() && !S.scoringEnded){ S.endWhy="All teams completed."; save(); }
      showSection("end");
    }else{
      showSection("play");
    }
    $("#dgname0").value=S.groupNames[0]; $("#dgname1").value=S.groupNames[1];
    $("#dparticipants").value=S.participants||""; $("#dremainder").value=S.remainderMode;
    $("#dskill0").value=S.skills[0]; $("#dskill1").value=S.skills[1]; $("#dskill2").value=S.skills[2]; $("#dskill3").value=S.skills[3];
    renderOwnerEditor();
  }

  $("#startBtn").addEventListener("click", ()=>{
    const sk=[$("#skill0").value||"Visual", $("#skill1").value||"Sound", $("#skill2").value||"Programming", $("#skill3").value||"Project Management"];
    const part=parseInt($("#participants").value||"0",10)||0;
    const g0=$("#gname0").value||"Group 1"; const g1=$("#gname1").value||"Group 2";
    const rem=$$("input[name='remainderMode']").find(r=>r.checked)?.value || "distribute";
    S.skills=sk; S.participants=part; S.groupNames=[g0,g1]; S.remainderMode=rem==="ownTeam"?"ownTeam":"distribute"; S.setupDone=true; save(); render();
  });

  $("#toggleDrawer").addEventListener("click", ()=>{ const d=$("#drawer"); d.classList.toggle("open"); $("#toggleDrawer").setAttribute("aria-expanded", d.classList.contains("open")?"true":"false"); });
  $("#drawerSave").addEventListener("click", ()=>{
    S.groupNames[0]=$("#dgname0").value||"Group 1"; S.groupNames[1]=$("#dgname1").value||"Group 2";
    S.participants=parseInt($("#dparticipants").value||"0",10)||0;
    S.remainderMode=$("#dremainder").value==="ownTeam"?"ownTeam":"distribute";
    S.skills=[$("#dskill0").value||"Visual", $("#dskill1").value||"Sound", $("#dskill2").value||"Programming", $("#dskill3").value||"Project Management"];
    save(); render();
  });

  $("#prevTeam").addEventListener("click", ()=>{ S.currentTeam=(S.currentTeam+S.teams.length-1)%S.teams.length; save(); render(); });
  $("#nextTeam").addEventListener("click", ()=>{ S.currentTeam=(S.currentTeam+1)%S.teams.length; save(); render(); });
  $("#backCard").addEventListener("click", ()=>{ if(S.currentCard>0){ S.currentCard--; save(); render(); } });
  $("#resetBtn").addEventListener("click", ()=>{ if(confirm("Clear all data and restart?")) resetAll(); });

  $("#lockBtn").addEventListener("click", ()=>{
    const ti=S.currentTeam, ci=S.currentCard, t=S.teams[ti];
    if(t.locked[ci]) return;
    if(sum(t.cards[ci])!==20){ alert("Sum must be exactly 20."); return; }
    t.locked[ci]=true;
    const {stage,target,max}=stageTargetForCardIndex(ci);
    let title="", ownerText="", percent=0, items=[];
    if(stage==="baseline"){
      title="First card locked — No score yet."; ownerText="No points for baseline (Card 1)."; percent=0; S.lastLock={team:ti,card:ci,stage,owner:-1,points:0,values:[...t.cards[ci]]};
    }else{
      const sums=teamSumUpTo(t,ci); const r=stagePointsFromSums(sums,target); const owner=ownerForStage(t,stage);
      S.totals[owner]+=r.pts; percent=Math.round((r.pts/max)*100);
      title=`${stage[0].toUpperCase()+stage.slice(1)} score — ${r.pts} / ${max} (${percent}%)`;
      ownerText=`Points → ${S.groupNames[owner]}`;
      items=r.perSkill.map((ps,idx)=>{ const nm=skillNames()[idx]; const d=ps.delta; if(d===0) return {text:`${nm}: On target`, cls:"sum-ok"}; if(d>0) return {text:`${nm}: +${d} over`, cls:"sum-over"}; return {text:`${nm}: ${d} under`, cls:"sum-under"}; });
      S.lastLock={team:ti,card:ci,stage,owner,points:r.pts,values:[...t.cards[ci]]};
    }
    save(); showOverlay(title, ownerText, percent, items);
  });
  function showOverlay(title, ownerText, percent, items){
    $("#overlayTitle").textContent=title; $("#overlayOwner").textContent=ownerText;
    $("#overlayPB").style.width=percent+"%"; const tags=$("#overlayStats"); tags.innerHTML=""; const list=$("#overlayList"); list.innerHTML="";
    items.forEach(it=>{ const tag=document.createElement("span"); tag.className="tag "+(it.cls||""); tag.textContent=it.text; tags.appendChild(tag);
      const li=document.createElement("li"); li.className=it.cls||""; li.textContent=it.text; list.appendChild(li); });
    $("#overlay").classList.add("show");
  }
  $("#overlayClose").addEventListener("click", ()=>{
    $("#overlay").classList.remove("show");
    if(S.currentCard<3){ S.currentCard++; } else { S.currentCard=0; S.currentTeam=(S.currentTeam+1)%S.teams.length; }
    save();
    if(allTeamsComplete()){ S.endWhy="All teams completed."; S.scoringEnded=true; save(); showSection("end"); } else { render(); }
  });
  $("#overlayUndo").addEventListener("click", ()=>{
    const last=S.lastLock; if(!last){ alert("Nothing to undo."); return; }
    const t=S.teams[last.team];
    if(last.stage!=="baseline" && last.owner>=0){ S.totals[last.owner]=Math.max(0, S.totals[last.owner] - (last.points||0)); }
    t.locked[last.card]=false; t.cards[last.card]=[...last.values]; S.currentTeam=last.team; S.currentCard=last.card; S.lastLock=null; save();
    $("#overlay").classList.remove("show"); render();
  });

  $("#toIntake").addEventListener("click", ()=>{ showSection("intake"); });
  $("#toFinal").addEventListener("click", ()=>{ showSection("final"); });

  function buildIntakeRows(){
    const wrap=$("#intakeRows"); wrap.innerHTML="";
    const remaining=Math.max(1, (S.participants||0)-totalEnteredCards());
    for(let i=0;i<remaining;i++) addIntakeRow();
  }
  function addIntakeRow(){
    const wrap=$("#intakeRows"); const row=document.createElement("div"); row.className="row"; row.style.flexWrap="nowrap"; row.style.gap="8px";
    const name=document.createElement("input"); name.type="text"; name.placeholder="Name"; name.style.minWidth="120px";
    const inputs=[]; for(let i=0;i<4;i++){ const n=document.createElement("input"); n.type="number"; n.min="0"; n.max="20"; n.step="1"; n.placeholder=skillNames()[i]; n.style.width="80px"; inputs.push(n); }
    const sumTag=document.createElement("span"); sumTag.className="tag"; sumTag.textContent="Sum: 0/20";
    function update(){ const s=inputs.reduce((a,b)=>a+(parseInt(b.value||"0",10)||0),0); sumTag.textContent=`Sum: ${s}/20`; sumTag.className="tag "+(s===20?"sum-ok":(s<20?"sum-under":"sum-over")); }
    inputs.forEach(n=>n.addEventListener("input", update));
    row.appendChild(name); inputs.forEach(n=>row.appendChild(n)); row.appendChild(sumTag); wrap.appendChild(row);
  }
  $("#addRow").addEventListener("click", addIntakeRow);

  $("#assignAuto").addEventListener("click", ()=>{
    const rows=Array.from($("#intakeRows").children); const cards=[];
    rows.forEach(r=>{ const name=r.querySelector('input[type="text"]').value.trim()||"Unnamed";
      const nums=Array.from(r.querySelectorAll('input[type="number"]')).map(n=>parseInt(n.value||"0",10)||0);
      if(sum(nums)===20) cards.push({name, values:nums}); });
    if(cards.length===0){ alert("No valid rows (sum=20) to assign."); return; }

    function nextStageInfoForTeam(t){
      const present = presentCountForTeamIndex(t);
      if(present<=0) return {stage:"pair", idx:1, target:10, effective:false};
      if(present===1) return {stage:"pair", idx:1, target:10, effective:true};
      if(present===2) return {stage:"triplet", idx:2, target:15, effective:true};
      return {stage:"quartet", idx:3, target:20, effective:true};
    }
    function presentCountForTeamIndex(team){
      let k=0; for(let ci=0;ci<4;ci++){ const vals=team.cards[ci]||[0,0,0,0]; const n=(team.names[ci]||"").trim();
        if(team.locked[ci] || n || vals.some(v=>v>0)) k++; } return k;
    }
    function predPoints(team, stageInfo, candVals){
      const idx=stageInfo.idx; const sums=teamSumUpTo(team, Math.min(idx-1,3));
      for(let k=0;k<4;k++) sums[k]+=candVals[k];
      const r=stagePointsFromSums(sums, stageInfo.target); return r.pts;
    }
    function placeCardInTeam(team, card){
      for(let i=0;i<4;i++){
        if(!(team.names[i]||"").trim() && sum(team.cards[i])===0 && !team.locked[i]){ team.names[i]=card.name; team.cards[i]=[...card.values]; team.locked[i]=true; return true; }
      }
      for(let i=0;i<4;i++){
        if(!team.locked[i]){ team.names[i]=team.names[i] || card.name; team.cards[i]=[...card.values]; team.locked[i]=true; return true; }
      }
      return false;
    }

    const pool=cards.slice();

    // DISTRIBUTE MODE: only fill teams that already have at least one member; otherwise extras later
    const baseTeams=S.teams.slice(0,4);
    const eligibleTeams=(S.remainderMode==="distribute") ? baseTeams.filter(t=>presentCountForTeamIndex(t)>0) : baseTeams;

    while(pool.length){
      const allFull = eligibleTeams.length>0 && eligibleTeams.every(t=>t.locked.filter(Boolean).length>=4);
      if(allFull) break;
      let best=null;
      for(let ti=0;ti<eligibleTeams.length;ti++){
        const team=eligibleTeams[ti]; const realTi=S.teams.indexOf(team);
        if(team.locked.filter(Boolean).length>=4) continue;
        const stageInfo=nextStageInfoForTeam(team);
        for(let ci=0;ci<pool.length;ci++){
          const card=pool[ci]; const pts=stageInfo.effective ? predPoints(team,stageInfo,card.values) : 0;
          const score=pts + (stageInfo.effective?10:0);
          if(!best || score>best.score){ best={ti:realTi, ci, score}; }
        }
      }
      if(!best) break;
      const card=pool.splice(best.ci,1)[0];
      const ok=placeCardInTeam(S.teams[best.ti], card);
      if(!ok){ S.teams[best.ti].extras.push(card); }
    }

    const leftovers=pool.slice();
    if(leftovers.length){
      if(S.remainderMode==="ownTeam"){
        let overflow=S.teams[4]; if(!overflow){ overflow=defaultTeam(4); S.teams.push(overflow); }
        for(const c of leftovers.splice(0,4)){
          for(let i=0;i<4;i++){ if(sum(overflow.cards[i])===0 && !overflow.names[i]){ overflow.cards[i]=[...c.values]; overflow.names[i]=c.name; overflow.locked[i]=true; break; } }
        }
        leftovers.forEach(c=>overflow.extras.push(c));
      }else{
        function fiveScore(team,cand){
          const base=[0,0,0,0];
          for(let i=0;i<4;i++){ const v=team.cards[i]||[0,0,0,0]; for(let k=0;k<4;k++) base[k]+=v[k]; }
          for(let k=0;k<4;k++) base[k]+=cand.values[k];
          let pts=0; for(let k=0;k<4;k++){ const d=Math.abs(25-base[k]); pts+=25-d; } return pts;
        }
        while(leftovers.length){
          let best=null;
          for(let ti=0;ti<4;ti++){
            const team=S.teams[ti];
            for(let ci=0;ci<leftovers.length;ci++){
              const cand=leftovers[ci]; const sc=fiveScore(team,cand);
              if(!best || sc>best.sc){ best={ti,ci,sc}; }
            }
          }
          const pick=leftovers.splice(best.ci,1)[0]; S.teams[best.ti].extras.push(pick);
        }
      }
    }

    save(); showSection("final");
  });

  function download(filename,text,mime){ const blob=new Blob([text],{type:mime||"text/plain"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },200); }
  $("#exportCSV").addEventListener("click", ()=>{
    const rows=[["Team","Slot","Name",...skillNames()]];
    S.teams.forEach((t,i)=>{
      for(let k=0;k<4;k++){ rows.push([`Team ${i+1}`, String(k+1), t.names[k]||"", ...(t.cards[k]||[0,0,0,0])]); }
      if(t.extras && t.extras.length){ t.extras.forEach((ex,idx)=>{ rows.push([`Team ${i+1}`, String(5+idx), ex.name||"", ...(ex.values||[0,0,0,0])]); }); }
    });
    const csv=rows.map(r=>r.map(v=>String(v).includes(",")?`"${String(v).replace(/"/g,'""')}"`:String(v)).join(",")).join("\n");
    download("teams.csv", csv, "text/csv");
  });
  $("#exportJSON").addEventListener("click", ()=>{
    const out={groupNames:S.groupNames, skills:S.skills, remainderMode:S.remainderMode,
      teams:S.teams.map(t=>({cards:t.cards, names:t.names, locked:t.locked, extras:t.extras, pairToGroup:t.pairToGroup, tripToGroup:t.tripToGroup, quadToGroup:t.quadToGroup}))};
    download("teams.json", JSON.stringify(out,null,2), "application/json");
  });
  $("#restart").addEventListener("click", ()=>{ if(confirm("This clears storage and reloads.")){ localStorage.removeItem(LSKEY); location.reload(); } });

  render();
})();</script>
</body>
</html>
